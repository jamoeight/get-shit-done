# Architecture Research: Terminal Path Resolution

**Domain:** Terminal launcher cross-platform path handling
**Researched:** 2026-01-21
**Confidence:** HIGH (verified with official documentation)

## Current Architecture Summary

The terminal launcher (`bin/lib/terminal-launcher.js`) uses a layered approach:

1. **Platform detection** - `process.platform` determines which terminal list to use
2. **Terminal detection** - `command-exists` package checks availability in order
3. **Launcher selection** - Each terminal has dedicated launcher functions
4. **Path formatting** - `toGitBashPath()` helper converts Windows paths to Git Bash format

**Current problem:** The wt.exe launcher forces Git Bash explicitly (`C:\Program Files\Git\bin\bash.exe`), but this:
- Fails if Git Bash is not installed at standard path
- Ignores user's preferred shell/profile
- Previous attempts to use user's default profile failed due to path format mismatch

**Path format requirements by bash type:**

| Bash Type | Path Format | Detection |
|-----------|-------------|-----------|
| Git Bash (MSYS2) | `/c/Users/...` | `$OSTYPE` = `msys` |
| WSL | `/mnt/c/Users/...` | `$OSTYPE` = `linux-gnu` + `/proc/sys/kernel/osrelease` contains "Microsoft" |
| Cygwin | `/cygdrive/c/Users/...` | `$OSTYPE` = `cygwin` |

## Option Analysis

### Option 1: Fix wt.exe launcher only (current approach)

**What it does:** Keep hardcoded Git Bash path in wt.exe launcher.

**Pros:**
- Minimal code change
- Predictable behavior
- Already implemented (commit 28739db)

**Cons:**
- Fails if Git Bash not at `C:\Program Files\Git\bin\bash.exe`
- Users with Git installed elsewhere cannot use wt.exe
- Ignores user's Windows Terminal preferences
- Other Windows launchers (cmd.exe, PowerShell) still use `toGitBashPath()` which assumes Git Bash

**Verdict:** PARTIAL FIX - Works for common case but fragile.

### Option 2: Universal path handling in ALL launchers

**What it does:** Add path conversion logic to every launcher function.

**Pros:**
- Consistent behavior across all terminals
- Future-proof for new terminals

**Cons:**
- High code churn (8+ launcher functions)
- Each launcher already works for its target environment
- Over-engineering: Linux/macOS launchers don't need Windows path handling
- Increases maintenance burden

**Verdict:** OVER-ENGINEERED - Violates minimal change principle.

### Option 3: Bash detection layer before path formatting

**What it does:** Detect which bash will be spawned, then format paths accordingly.

```javascript
// Conceptual approach
function detectBashType() {
  const result = execSync('bash -c "echo $OSTYPE"').toString().trim();
  if (result.startsWith('msys')) return 'gitbash';
  if (result.startsWith('cygwin')) return 'cygwin';
  if (result === 'linux-gnu') return 'wsl';
  return 'native';
}

function toPathFormat(windowsPath, bashType) {
  switch (bashType) {
    case 'gitbash': return toGitBashPath(windowsPath);
    case 'wsl': return toWslPath(windowsPath);
    case 'cygwin': return toCygwinPath(windowsPath);
    default: return windowsPath;
  }
}
```

**Pros:**
- Handles any bash type correctly
- Single source of truth for path conversion
- Could work with user's default profile

**Cons:**
- Synchronous exec at launcher time adds latency
- Detection runs in current shell, not the shell wt.exe will spawn
- Race condition: user could change default profile between detection and launch
- Complexity: adds new abstraction layer

**Verdict:** PROBLEMATIC - Detection environment differs from spawn environment.

### Option 4: Runtime resolution in bash command

**What it does:** Pass Windows path and use bash-side logic to convert at runtime.

```javascript
// Instead of pre-converting:
const bashCwd = toGitBashPath(cwd);
`cd "${bashCwd}" && bash "${bashScript}"`

// Do runtime conversion:
const winCwd = cwd.replace(/\\/g, '\\\\');  // Escape backslashes
const winScript = scriptPath.replace(/\\/g, '\\\\');
`
WINPATH='${winCwd}'
if command -v cygpath &>/dev/null; then
  CD_PATH=$(cygpath -u "$WINPATH")
elif command -v wslpath &>/dev/null; then
  CD_PATH=$(wslpath -u "$WINPATH")
else
  CD_PATH=$(echo "$WINPATH" | sed 's|\\\\|/|g; s|^\\([A-Za-z]\\):|/\\L\\1|')
fi
cd "$CD_PATH" && bash "$(echo '${winScript}' | similar_conversion)"
`
```

**Pros:**
- Works regardless of which bash is spawned
- No detection needed - conversion happens in target environment
- Uses native tools (cygpath, wslpath) when available
- Fallback regex handles edge cases

**Cons:**
- Complex bash command string
- Harder to debug
- Escaping challenges for paths with special characters
- Performance: spawns subshells for path conversion

**Verdict:** ROBUST but COMPLEX - Correct solution, implementation overhead.

### Option 5: Explicit profile specification (wt.exe -p "Git Bash")

**What it does:** Use `wt.exe -p "profile-name"` to force a specific profile.

```javascript
// Per Microsoft docs, -p specifies profile by name
spawn('wt.exe', ['-p', 'Git Bash', '-d', cwd, '--', 'bash', '-c', '...']);
```

**Pros:**
- Uses Windows Terminal's intended mechanism
- Profile name is human-readable in code
- `-d` flag sets working directory natively (no path conversion needed!)

**Cons:**
- Profile name varies by user ("Git Bash", "git bash", "Git Bash (Default)", etc.)
- Profile might not exist (user didn't install Git Bash as WT profile)
- Falls back to default profile if specified profile not found - silent failure

**Verification from Microsoft docs:**
> "Use the `-p` flag to specify the Windows Terminal profile that you want to open."
> "The `-d` argument lets you pick the starting directory."

**Verdict:** ELEGANT if profile exists, UNRELIABLE as universal solution.

## Recommended Architecture

**Recommendation: Hybrid approach combining Options 1 and 4**

Use the current explicit Git Bash approach (Option 1) but with a robust fallback using runtime resolution (Option 4) for edge cases.

### Rationale

1. **Current fix works for 90%+ of users** - Git Bash at standard path is extremely common
2. **Runtime resolution handles edge cases** - Non-standard installs, profile variations
3. **Minimal change principle** - Don't touch working Linux/macOS launchers
4. **Separation of concerns** - Path conversion stays in Windows-specific code

### Proposed Architecture

```
bin/lib/terminal-launcher.js
    |
    +-- toGitBashPath()          # Existing (used by cmd.exe, powershell)
    +-- toWslPath()              # NEW: WSL format /mnt/c/...
    +-- toCygwinPath()           # NEW: Cygwin format /cygdrive/c/...
    +-- toUniversalBashCommand() # NEW: Runtime-resolving path wrapper
    |
    +-- launchWindowsTerminal()
    |   Uses: Explicit Git Bash path (current working approach)
    |   Fallback: toUniversalBashCommand() if Git Bash not found
    |
    +-- launchCmd()              # Uses: toGitBashPath() (unchanged)
    +-- launchPowerShell()       # Uses: toGitBashPath() (unchanged)
    +-- launchGitBash()          # Uses: toGitBashPath() (unchanged)
    |
    +-- launchMacTerminal()      # Unchanged (no conversion needed)
    +-- launchGnomeTerminal()    # Unchanged (no conversion needed)
    +-- launchXterm()            # Unchanged (no conversion needed)
```

### Implementation Detail: toUniversalBashCommand()

```javascript
/**
 * Generate a bash command that resolves Windows path at runtime
 * Works regardless of which bash variant executes it
 */
function toUniversalBashCommand(windowsCwd, windowsScript) {
  // Escape single quotes and backslashes for embedding in bash
  const escCwd = windowsCwd.replace(/\\/g, '/').replace(/'/g, "'\\''");
  const escScript = windowsScript.replace(/\\/g, '/').replace(/'/g, "'\\''");

  return `
resolve_path() {
  local winpath="$1"
  if command -v cygpath >/dev/null 2>&1; then
    cygpath -u "$winpath"
  elif command -v wslpath >/dev/null 2>&1; then
    wslpath -u "$winpath"
  else
    # Fallback: assume MSYS-style /c/ prefix
    echo "$winpath" | sed 's|^\\([A-Za-z]\\):/|/\\L\\1/|'
  fi
}
cd "$(resolve_path '${escCwd}')" && bash "$(resolve_path '${escScript}')"
`.trim();
}
```

### When to Use Each Approach

| Scenario | Approach |
|----------|----------|
| Git Bash at standard path | Current explicit path (fast, reliable) |
| Git Bash not found | Fall back to toUniversalBashCommand() |
| cmd.exe / PowerShell | toGitBashPath() (spawns Git Bash via PATH) |
| macOS / Linux | Native paths (no conversion) |

## Alternative: Simplest Fix

If the hybrid approach is considered over-engineering for the current bug, the **simplest fix** is:

1. Keep current explicit Git Bash approach
2. Add existence check for Git Bash executable
3. If not found, skip wt.exe and fall through to cmd.exe launcher

```javascript
function launchWindowsTerminal(scriptPath, windowTitle = 'GSD') {
  const gitBashPath = 'C:\\Program Files\\Git\\bin\\bash.exe';

  // Check if Git Bash exists at standard path
  if (!fs.existsSync(gitBashPath)) {
    return null; // Signal to try next terminal in priority list
  }

  // ... rest of existing implementation
}
```

This requires updating `findTerminal()` to handle null returns and try the next terminal.

## Decision Matrix

| Approach | Reliability | Complexity | Risk | Recommendation |
|----------|-------------|------------|------|----------------|
| Current (explicit Git Bash) | HIGH for common case | LOW | Breaks if Git Bash not installed | ACCEPTABLE as-is for v1.2 |
| Add existence check | HIGH | LOW | None | RECOMMENDED as minimal fix |
| Runtime resolution | HIGHEST | MEDIUM-HIGH | Escaping bugs | DEFER to future if needed |

## Sources

- [Windows Terminal command line arguments - Microsoft Learn](https://learn.microsoft.com/en-us/windows/terminal/command-line-arguments)
- [MSYS2 Filesystem Paths](https://www.msys2.org/docs/filesystem-paths/)
- [cygpath - Cygwin documentation](https://cygwin.com/cygwin-ug-net/cygpath.html)
- [GitHub: wslpath utility](https://github.com/laurent22/wslpath)
- [MSYS2 Environments - $OSTYPE detection](https://www.msys2.org/docs/environments/)
- [GitHub Issue #9883: Claude Code Bash tool incompatible with MSYS/Git Bash](https://github.com/anthropics/claude-code/issues/9883)

## Confidence Assessment

| Aspect | Level | Reason |
|--------|-------|--------|
| Path formats | HIGH | Verified with official MSYS2, Cygwin, WSL documentation |
| wt.exe flags | HIGH | Verified with Microsoft official documentation |
| cygpath availability | HIGH | Verified - ships with Git Bash (MSYS2) |
| wslpath availability | HIGH | Built into WSL (Microsoft-provided) |
| $OSTYPE values | HIGH | Verified across multiple authoritative sources |
| Recommended approach | MEDIUM | Architectural judgment; actual effectiveness requires testing |

---

*Architecture research for v1.2 terminal path resolution bug: 2026-01-21*
