---
phase: 11-terminal-launcher
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bin/lib/terminal-launcher.js
autonomous: true

must_haves:
  truths:
    - "Platform is correctly detected (win32, darwin, linux)"
    - "Terminal emulator is found from list of candidates"
    - "Terminal process is spawned detached from parent"
    - "If no terminal found, manual instructions are displayed"
  artifacts:
    - path: "bin/lib/terminal-launcher.js"
      provides: "Cross-platform terminal launcher module"
      exports: ["launchTerminal"]
      min_lines: 150
    - path: "package.json"
      provides: "command-exists dependency"
      contains: "command-exists"
  key_links:
    - from: "bin/lib/terminal-launcher.js"
      to: "command-exists"
      via: "require"
      pattern: "require\\('command-exists'\\)"
    - from: "bin/lib/terminal-launcher.js"
      to: "child_process"
      via: "require"
      pattern: "require\\('child_process'\\)"
---

<objective>
Create a Node.js module that detects the operating system, finds an available terminal emulator, and launches ralph.sh in a new terminal window as a detached process.

Purpose: This module enables execution isolation - the core value proposition of Phase 11. Users can close their Claude session while ralph.sh continues running independently.

Output: bin/lib/terminal-launcher.js module with launchTerminal() function
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-terminal-launcher/11-RESEARCH.md

# Existing lib files follow this pattern
@bin/lib/budget.sh

# Package.json for dependency addition
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependency and create terminal-launcher.js skeleton</name>
  <files>package.json, bin/lib/terminal-launcher.js</files>
  <action>
1. Install command-exists package:
   ```bash
   npm install command-exists --save
   ```

2. Create bin/lib/terminal-launcher.js with the following structure:

```javascript
#!/usr/bin/env node
// Terminal Launcher - Cross-platform terminal window spawning
// Part of Phase 11: Terminal Launcher
//
// Detects platform, finds available terminal emulator, launches ralph.sh
// in a new window as a detached process for execution isolation.

const { spawn } = require('child_process');
const path = require('path');

// command-exists for checking terminal availability
let commandExistsSync;
try {
  commandExistsSync = require('command-exists').sync;
} catch (e) {
  // Fallback if command-exists not installed
  commandExistsSync = () => false;
}

// Terminal configurations by platform
// Order matters - first available terminal is used
const TERMINAL_CONFIG = {
  win32: [
    { name: 'wt.exe', launcher: launchWindowsTerminal },
    { name: 'cmd.exe', launcher: launchCmd },
    { name: 'powershell.exe', launcher: launchPowerShell },
    { name: 'bash.exe', launcher: launchGitBash }
  ],
  darwin: [
    { name: 'osascript', launcher: launchMacTerminal }
  ],
  linux: [
    { name: 'gnome-terminal', launcher: launchGnomeTerminal },
    { name: 'xterm', launcher: launchXterm },
    { name: 'x-terminal-emulator', launcher: launchXtermEmulator }
  ]
};
```

3. Implement findTerminal() function:
```javascript
function findTerminal(platform) {
  const terminals = TERMINAL_CONFIG[platform] || [];

  for (const terminal of terminals) {
    try {
      if (commandExistsSync(terminal.name)) {
        return terminal;
      }
    } catch (err) {
      continue;
    }
  }

  return null;
}
```

4. Implement platform-specific launcher functions:

For Windows cmd.exe:
```javascript
function launchCmd() {
  const cwd = process.cwd();
  const script = path.join(cwd, 'bin', 'ralph.sh').replace(/\\/g, '/');

  return spawn('cmd.exe', ['/c', 'start', 'cmd', '/k', `bash "${script}"`], {
    detached: true,
    stdio: 'ignore',
    cwd: cwd,
    shell: false
  });
}
```

For Windows PowerShell:
```javascript
function launchPowerShell() {
  const cwd = process.cwd();
  const script = path.join(cwd, 'bin', 'ralph.sh').replace(/\\/g, '/');

  return spawn('powershell.exe', [
    '-Command', 'Start-Process', 'powershell',
    '-ArgumentList', `"-NoExit", "-Command", "cd '${cwd.replace(/'/g, "''")}'; bash '${script}'"`
  ], {
    detached: true,
    stdio: 'ignore',
    cwd: cwd,
    shell: false
  });
}
```

For Windows Terminal:
```javascript
function launchWindowsTerminal() {
  const cwd = process.cwd();
  const script = path.join(cwd, 'bin', 'ralph.sh').replace(/\\/g, '/');

  return spawn('wt.exe', [
    '--title', 'GSD Ralph',
    'bash', script
  ], {
    detached: true,
    stdio: 'ignore',
    cwd: cwd,
    shell: false
  });
}
```

For Git Bash:
```javascript
function launchGitBash() {
  const cwd = process.cwd();
  const script = path.join(cwd, 'bin', 'ralph.sh').replace(/\\/g, '/');

  return spawn('cmd.exe', [
    '/c', 'start', '""', 'bash', '--login', '-i', '-c',
    `cd "${cwd.replace(/\\/g, '/')}" && bash "${script}"`
  ], {
    detached: true,
    stdio: 'ignore',
    cwd: cwd,
    shell: false
  });
}
```

For macOS Terminal.app:
```javascript
function launchMacTerminal() {
  const cwd = process.cwd();
  const script = path.join(cwd, 'bin', 'ralph.sh');

  // Escape for AppleScript
  const escapedCwd = cwd.replace(/"/g, '\\"');
  const escapedScript = script.replace(/"/g, '\\"');

  const appleScript = `tell application "Terminal"
    do script "cd \\"${escapedCwd}\\" && \\"${escapedScript}\\""
    activate
end tell`;

  return spawn('osascript', ['-e', appleScript], {
    detached: true,
    stdio: 'ignore',
    cwd: cwd
  });
}
```

For Linux gnome-terminal:
```javascript
function launchGnomeTerminal() {
  const cwd = process.cwd();
  const script = path.join(cwd, 'bin', 'ralph.sh');

  return spawn('gnome-terminal', [
    '--window',
    '--title=GSD Ralph',
    '--',
    'bash', '-c', `cd "${cwd}" && "${script}"; exec bash`
  ], {
    detached: true,
    stdio: 'ignore',
    cwd: cwd
  });
}
```

For Linux xterm:
```javascript
function launchXterm() {
  const cwd = process.cwd();
  const script = path.join(cwd, 'bin', 'ralph.sh');

  return spawn('xterm', [
    '-hold',
    '-title', 'GSD Ralph',
    '-e', `cd "${cwd}" && "${script}"`
  ], {
    detached: true,
    stdio: 'ignore',
    cwd: cwd
  });
}

function launchXtermEmulator() {
  // x-terminal-emulator is a Debian alternatives symlink
  // Use same approach as xterm
  return launchXterm();
}
```
  </action>
  <verify>
- File exists: `ls bin/lib/terminal-launcher.js`
- Dependency installed: `grep command-exists package.json`
- No syntax errors: `node -c bin/lib/terminal-launcher.js`
  </verify>
  <done>terminal-launcher.js exists with all platform-specific launcher functions and command-exists dependency is in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Add manual fallback and export launchTerminal function</name>
  <files>bin/lib/terminal-launcher.js</files>
  <action>
1. Add showManualInstructions() function for EXEC-03 fallback:

```javascript
function showManualInstructions(platform) {
  const cwd = process.cwd();
  const script = path.join(cwd, 'bin', 'ralph.sh');

  console.log('\n==========================================');
  console.log(' TERMINAL LAUNCH UNAVAILABLE');
  console.log('==========================================\n');
  console.log('Could not detect a supported terminal emulator.\n');
  console.log('To run autopilot manually:\n');
  console.log('  1. Open a new terminal window');
  console.log(`  2. cd ${cwd}`);

  if (platform === 'win32') {
    console.log(`  3. bash ${script}\n`);
    console.log('Supported terminals on Windows:');
    console.log('  - Windows Terminal (wt.exe)');
    console.log('  - Command Prompt (cmd.exe)');
    console.log('  - PowerShell');
    console.log('  - Git Bash');
  } else if (platform === 'darwin') {
    console.log(`  3. ${script}\n`);
    console.log('Supported terminals on macOS:');
    console.log('  - Terminal.app');
  } else {
    console.log(`  3. ${script}\n`);
    console.log('Supported terminals on Linux:');
    console.log('  - gnome-terminal');
    console.log('  - xterm');
    console.log('  - x-terminal-emulator');
  }

  console.log('\n==========================================\n');
}
```

2. Implement the main launchTerminal() function:

```javascript
/**
 * Launch ralph.sh in a new terminal window
 *
 * @returns {Object} Result object with:
 *   - success: boolean - whether terminal was launched
 *   - terminal: string - terminal name used (if success)
 *   - pid: number - process ID (if success)
 *   - reason: string - failure reason (if !success)
 *   - error: string - error message (if launch failed)
 */
function launchTerminal() {
  const platform = process.platform;
  const terminal = findTerminal(platform);

  if (!terminal) {
    showManualInstructions(platform);
    return { success: false, reason: 'no_terminal_found' };
  }

  try {
    const subprocess = terminal.launcher();
    subprocess.unref(); // Critical: allow parent to exit independently

    console.log(`\nLaunched ralph.sh in new ${terminal.name} window`);
    console.log('You can now close this Claude session - ralph.sh will continue running.\n');

    return {
      success: true,
      terminal: terminal.name,
      pid: subprocess.pid
    };
  } catch (err) {
    console.error(`\nFailed to launch ${terminal.name}: ${err.message}\n`);
    showManualInstructions(platform);
    return {
      success: false,
      reason: 'launch_failed',
      error: err.message
    };
  }
}
```

3. Add module exports at the end of the file:

```javascript
module.exports = {
  launchTerminal,
  findTerminal,  // Exported for testing
  showManualInstructions  // Exported for direct use if needed
};
```

4. Add CLI support for standalone testing:

```javascript
// CLI support - run directly for testing
if (require.main === module) {
  console.log('Terminal Launcher Test');
  console.log('Platform:', process.platform);

  const terminal = findTerminal(process.platform);
  if (terminal) {
    console.log('Found terminal:', terminal.name);
    console.log('\nLaunching terminal in 3 seconds...');
    setTimeout(() => {
      const result = launchTerminal();
      console.log('Result:', JSON.stringify(result, null, 2));
      process.exit(result.success ? 0 : 1);
    }, 3000);
  } else {
    console.log('No terminal found');
    showManualInstructions(process.platform);
    process.exit(1);
  }
}
```
  </action>
  <verify>
- Module loads without error: `node -e "require('./bin/lib/terminal-launcher.js')"`
- Exports are correct: `node -e "const t = require('./bin/lib/terminal-launcher.js'); console.log(typeof t.launchTerminal)"`
- Terminal detection works: `node -e "const t = require('./bin/lib/terminal-launcher.js'); console.log(t.findTerminal(process.platform))"`
  </verify>
  <done>launchTerminal() function is exported and includes manual fallback instructions when terminal detection fails</done>
</task>

</tasks>

<verification>
1. Module can be required without errors
2. launchTerminal function is exported
3. findTerminal returns a terminal object on supported platforms
4. Manual instructions display when no terminal found
5. No npm audit issues with command-exists
</verification>

<success_criteria>
- [ ] command-exists dependency added to package.json
- [ ] bin/lib/terminal-launcher.js exists with 150+ lines
- [ ] launchTerminal() detects platform (process.platform)
- [ ] launchTerminal() finds terminal from TERMINAL_CONFIG
- [ ] launchTerminal() spawns detached process (detached: true, stdio: 'ignore', .unref())
- [ ] showManualInstructions() displays fallback when no terminal found
- [ ] Module exports launchTerminal function
</success_criteria>

<output>
After completion, create `.planning/phases/11-terminal-launcher/11-01-SUMMARY.md`
</output>
