---
phase: 04-git-checkpointing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - bin/lib/checkpoint.sh
  - bin/ralph.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Last completed task can be extracted from git history"
    - "Ralph validates STATE.md against git history at startup"
    - "Conflicts between STATE.md and git history trigger user prompt"
    - "Silent pass when STATE.md and git history agree"
    - "Progress can be reconstructed if STATE.md is lost"
  artifacts:
    - path: "bin/lib/checkpoint.sh"
      provides: "History recovery functions"
      exports: ["get_last_checkpoint_task", "validate_state_against_history"]
  key_links:
    - from: "bin/ralph.sh"
      to: "validate_state_against_history"
      via: "function call at startup"
      pattern: "validate_state_against_history"
    - from: "validate_state_against_history"
      to: "get_last_checkpoint_task"
      via: "internal function call"
      pattern: "get_last_checkpoint_task"
    - from: "get_last_checkpoint_task"
      to: "git log --grep"
      via: "git command"
      pattern: 'git log.*--grep.*Ralph checkpoint'
---

<objective>
Implement history recovery and STATE.md validation from git checkpoint history.

Purpose: If STATE.md is lost or corrupted, progress can be reconstructed from git history. At startup, validate that STATE.md agrees with checkpoint commits to catch inconsistencies early.

Output: Working recovery functions and startup validation that compares STATE.md position against git checkpoint history.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context and research
@.planning/phases/04-git-checkpointing/04-CONTEXT.md
@.planning/phases/04-git-checkpointing/04-RESEARCH.md

# Prior plan for this phase
@.planning/phases/04-git-checkpointing/04-01-SUMMARY.md

# Code to extend
@bin/lib/checkpoint.sh
@bin/ralph.sh
@bin/lib/parse.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add history recovery functions to checkpoint.sh</name>
  <files>bin/lib/checkpoint.sh</files>
  <action>
Add two new functions to bin/lib/checkpoint.sh:

**get_last_checkpoint_task()** - Extract last completed task from git history:
1. Search for most recent Ralph checkpoint commit:
   `git log --oneline --grep="Ralph checkpoint:" -1 2>/dev/null`
2. If empty result, echo "" and return 0 (no checkpoints yet)
3. Extract task ID using: `grep -oE '[0-9]{2}-[0-9]{2}' | head -1`
4. Echo the task ID and return 0

**validate_state_against_history()** - Compare STATE.md with git history:
1. Get current task from STATE.md: `parse_next_task` (from parse.sh)
2. Get last completed task from git: `get_last_checkpoint_task`
3. If git_task is empty, return 0 silently (no history to validate against)
4. Compare positions:
   - If state_task appears BEFORE git_task in ROADMAP.md sequence, there's a conflict
   - Use task ID comparison: if state's phase-plan < git's phase-plan, conflict
5. On conflict:
   - If interactive (`[[ -t 0 ]]`):
     - Print warning: "STATE.md and git history conflict"
     - Show: "STATE.md next task: $state_task"
     - Show: "Git last completed: $git_task"
     - Prompt: "Trust [s]tate or [g]it history? "
     - If 's', return 0 (continue with STATE.md)
     - If 'g', echo suggested command to user: "Run: ./bin/ralph.sh --start-from $(next_after_git_task)"
       Then return 1 (user should restart with suggested command)
   - If non-interactive, warn and return 1 (fail safe)
6. On match or state ahead of git: return 0 silently

For task comparison, use simple string comparison since format is NN-MM (e.g., "04-01" < "04-02").
  </action>
  <verify>
`bash -n bin/lib/checkpoint.sh` - no syntax errors
`grep -q "get_last_checkpoint_task" bin/lib/checkpoint.sh` - function exists
`grep -q "validate_state_against_history" bin/lib/checkpoint.sh` - function exists
  </verify>
  <done>
checkpoint.sh has get_last_checkpoint_task and validate_state_against_history functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate history validation at ralph.sh startup</name>
  <files>bin/ralph.sh</files>
  <action>
Modify bin/ralph.sh to validate STATE.md against git history at startup:

1. After `validate_git_state` call (added in 04-01), add history validation:
   ```bash
   # Validate STATE.md against git checkpoint history
   if ! validate_state_against_history; then
       echo -e "${YELLOW}Please resolve the conflict and restart${RESET}"
       exit 1
   fi
   ```

2. This validation runs AFTER validate_git_state (so we know we're in a clean git repo) but BEFORE the main loop starts.

The order at startup should now be:
1. load_config
2. show_startup_summary
3. validate_git_state (abort if dirty or not git repo)
4. validate_state_against_history (warn if STATE.md conflicts with git)
5. mark_checkpoint
6. enter main loop

The validation is silent when STATE.md and git history agree (per CONTEXT.md: "Silent unless conflict").
  </action>
  <verify>
`grep -q "validate_state_against_history" bin/ralph.sh` - validation called at startup
Run ralph.sh with consistent STATE.md - should start silently
  </verify>
  <done>
ralph.sh validates STATE.md against git history at startup, warns on conflict
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `bash -n bin/lib/checkpoint.sh` - no syntax errors
2. `grep -q "get_last_checkpoint_task" bin/lib/checkpoint.sh` - function exists
3. `grep -q "validate_state_against_history" bin/lib/checkpoint.sh` - function exists
4. `grep -q "validate_state_against_history" bin/ralph.sh` - validation integrated
5. Test: Create a checkpoint commit, modify STATE.md to point at earlier task, run ralph.sh - should warn
6. Test: With consistent STATE.md, ralph.sh starts silently
</verification>

<success_criteria>
- get_last_checkpoint_task extracts task ID from most recent checkpoint commit
- validate_state_against_history compares STATE.md with git history
- Conflicts prompt user interactively (or fail in non-interactive mode)
- Consistent state passes silently (no output)
- Progress can be determined from git history alone if needed
</success_criteria>

<output>
After completion, create `.planning/phases/04-git-checkpointing/04-02-SUMMARY.md`
</output>
